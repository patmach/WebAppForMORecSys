# Documentation - WebAppForMORecSys

## How to run web app

### Run

- Set connection string to the database in the file `appsettings.json`

- Set URI of the recommender in the database in table (table `RecommenderSystems`)

  - If new RS used, set variable `_recommenderSystemName` in `SystemParameters.cs`

- Set variable `BaseAddress` in `SystemParameters.cs` 

  - Currently needed only for user study purposes

- Add the `docker-compose.yml` and main directory of application to the same directory.

- Content of `docker-compose.yml`:

  - ```yaml
    version: "3.9"
    services:
      sql-server-db:
        #Database container parameters. Not needed when connecting to remote db
    
      webapp:
        build: ./WebAppForMORecSys
        ports:
        	- "44397:80" #Will listen locally on http://localhost:44397
       	#   - "80:80" when expose
        #depends_on: 
        #  - sql-server-db # Not needed when connecting to remote db
        #  - rs #Not needed when calling remote RS
        container_name: webapp
        #expose: #Only if you want to expose web app
        #  - "80"
    
    
      rs:
        #Recommender system container parameters. Not needed when calling remote RS
    
    ```

- Run `docker compose up` in shell



### Local Run

- Download and install `ASP.NET Core Runtime`
  - https://dotnet.microsoft.com/en-us/download/dotnet/7.0
- 2 options
  - Run from Visual Studio 2022
  - Or run in shell 
    - `dotnet run --project WebAppForMORecSys/WebAppForMORecSys.csproj`





## Documentation

### Detailed documentation

Detailed documentation of classes, functions and properties generated from doc comments in code can be found here: [HTML documentation](html/namespaces.html)

### Data Model

#### Base

![WebAppDiagram](Images\DataModel.png)

##### Account

Entity created from registration of the user and used for autorhization and authentication of the user.



##### User

Entity that represents user that could be without account (users retrieved from datasets). Possibly connected to account by username.



##### Item

Entity representing item with basic properties. JSONParams used for domain specific properties,



##### Rating

Entity representing rating given by user to item.



##### Interaction

Any interaction between user and item besides rating. Could be click, seen,...



##### Recommender System

We should define recommender system that we use in the database with its URI. 



##### Metric

Objective used in recommender system.



##### MetricVariant

Represents variant of the metric used in recommender system based on which the score of the objective would be computed.



##### UserMetricVariant

Used variant of the metric by the user (maximum 1 per user - objective(=Metric))



#### User Study Data Model

![WebAppDiagram](Images\DataModelForm.png)

The data model is extended to allow the user study to be executed within the application.



##### Question

Entity of question from the questionnaire of user study. 3 different types of answer: Likert Scale, Options (specific), Text



##### Answer

Instance of Answer is one possible answer to Question. Used for questions with Options (specific)  type of answer.



##### UserAnswer

User answer to the question.



##### QuestionsSection

Section of one or more question that are displayed simultaneously in the questionnaire



##### Acts

Action that user can perform within the user study.



##### UserActs

Actions performed by the user



##### UserActSuggestions

Suggestion to the user to make specific action.



##### QuestionAct

Dependency of question displaying in the questionnaire on performed action.





### Architecture of code

![WebAppDiagram](Images\WebAppDiagram.png)



##### Model

Represents classes from data models mentioned above.



###### ItemDomainExtension

Allows item to be interpreted as specific domain object (currently only movie)



###### ViewModel

Every class belongs to same view (page) and contains all data needed by the View



##### Views

Views and partial views (pages and their parts) that are displayed to the user. Shared - can be used for any domain, Movies - specific for usage in movie domain



##### Controllers

Control logic of the application that handles user requests to the app, changes model and return Views. Divided by Model entity that they work with. HomeController handles request for main pages. MoviesController handles requests specific for movie domain.



##### wwwroot

Javascript and CSS files and libraries. Static files (Images).



##### Identity

Generated by ASP.NET Core used for autentication and authorization of the user.



##### RequestHandlers

Handles request to recommend items, sends request to the recommender system, process its response and returns recommended items.



##### Helpers

Contains classes that are used as facade for working with JSON properties of user and item. Contains Loader of MovieLens data. 



##### Data

Contains class whose instance are relations of connection to the database. Database query handling.



##### Loggers

Contain FileLogger class



##### Settings

Not in diagram. Used by almost all parts of code. Contains definition of enums representing variants of settings that user can choose, selection of default variants for new user and system parameters that stands across the app.



## Communication

### Communication with the database

- Using EFCore
- ApplicationDbContext class in the Data folder
  - Instance of this class is created for each request to controller
    - ApplicationDbContext  instance needs to be parameter of its constructor



### Communication with the recommender system

The web app is made to use multi-objective recommender systems where user can specify preference to each objective by weights.

- Parameters saved to the database
  - Recommender system URI 
    - The expected URI to send request is: {Recommender system URI}/getRecommendations/{user ID}
  - Objectives
    - Needs to be saved in the table Metrics
      - Text of 4-scale default explanations should be specified (unless there is one or more variant of the metric in the database)
      - Description and Example properties used currently only for HELP texts for user to understand them
    - Needs to be used in the same order as in the RS
  - Metric Variants
    - Needs to be saved in the table MetricVariant
      - Unique code of the variant that is interpreted the same by RS
      - Text of 4-scale explanations should be specified

- Request to the RS
  - Specified by `RecommenderQuery` class (RequestHandlers)

- Response from the RS
  - Form of `Dictionary<int, double[]>`
    - Keys: IDs of recommended items
    - Values: Score per objective (=Metric) of the item

- Example of request data

  - ```json
    {
    	'whiteListItemIDs': [32, 47, 253, 266, 555, 1061, 1619, 2340, 2959, 2997, 3418, 4011, 4161, 4901, 4963, 7458, 8984, 33679, 46723, 53322, 55363, 61323, 64957, 68157, 81564, 86898, 89492, 103249, 105844, 115210, 148626, 187593, 202429],
    	'blackListItemIDs': [189363, 93840, 1682, 590, 1580, 2953, 95441, 1, 45722, 5349, 96079, 49272, 108190],
        'currentListItemIDs': [],
        'count': 15,
        'metrics': [33, 26, 20, 13, 6],
        'metricVariantsCodes': ['also_negative', 'maximal_diversity', 'intra_list_distance_based_novelty', 'avg_ratings', '']
    }
    ```

- Example of response data

  - ```json
    {
        "168": [95.71171602775985, 90.08456836777941, 62.680255494616, 10.737544026390541, 83.19340759715217],
    	"160080": [94.70690543417534, 86.10188818703168, 70.41777030835512, 23.193101704706365, 39.21020047427453], 
        "27773": [99.71952522566625, 90.93282368158113, 1.476083275329402, 88.42896025155231, 94.51327923054002], 
        "94018": [94.64414362384046, 84.81483799958659, 58.86083472131182, 30.756441368076377, 34.69852102567428], 
        "3979": [87.68170424540077, 87.15829205637759, 53.97749593454705, 43.73617016040326, 20.496661704893988], 
        "60397": [97.31801155313336, 85.87358812670686, 34.096195458569525, 48.736968725374076, 94.68283336366451], 
        "95558": [91.63793814711464, 97.67549723992501, 68.7215793929318, 9.350243532378876, 98.89009430388575], 
        "55577": [87.9570011069638, 91.26715900713194, 64.42218498251766, 22.823267980484623, 97.57380037878883], 
        "204698": [98.1984015886596, 99.71628909747466, 65.881612128059, 1.580463602815664, 85.23852968622566], 
        "2393": [92.491029176663, 96.6300721463742, 54.10505506159712, 25.419011549960217, 89.43264999360598], 
        "100498": [86.1471291571386, 84.57454407043521, 79.54912282734999, 16.67257131503161, 55.89537297504624], 
        "788": [94.43437957463668, 78.63961422770002, 23.402628781946795, 70.33597847370129, 98.00451946878945], 
        "193": [86.95403350949059, 98.84893665372616, 81.93941764211442, 7.598383831758807, 19.764971554860637], 
        "60950": [94.12007165888708, 94.11694461263582, 23.557400032800015, 54.69261906835441, 86.94939033589546], 
        "6157": [99.25873670128004, 66.93127685838842, 30.06585228955807, 67.0191718964582, 23.561599383964623]}
    
    ```

    

  

  

