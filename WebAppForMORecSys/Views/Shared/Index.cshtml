@using System.Text.Json;
@using WebAppForMORecSys.Models.ViewModels
@using static WebAppForMORecSys.Settings.SystemParameters
@model WebAppForMORecSys.Models.ViewModels.MainViewModel
@{
    ViewData["Title"] = "Home Page";
    string controller = WebAppForMORecSys.Settings.SystemParameters.Controller;
    int index = 0;
    Metric[] metricsArr = Model.Metrics.Keys.ToArray();
    var loadMoreURLArguments = new
    {
        typeOfSearch = Model.FilterValues["TypeOfSearch"] ?? "",
        search = Model.SearchValue ?? "",
        director = Model.FilterValues["Director"] ?? "",
        actor = Model.FilterValues["Actor"] ?? "",
        genres = Model.FilterValues["Genres"].Split(',') ?? new string[0],
        releasedateto = Model.FilterValues["ReleaseDateTo"] ?? "",
        releasedatefrom = Model.FilterValues["ReleaseDateFrom"] ?? "",
        metricsimportance = Model.FilterValues["MetricsImportance"].Split(',') ?? new string[0]
    };
    var loadMoreURL = Url.Action("Recommendations", controller, loadMoreURLArguments);

}
@if (!string.IsNullOrEmpty(Model.Info))
{
    <div class="card bg-warning infocard ">
        <div class="card-header">
            Tip
            <button type="button" class="close bg-dark" aria-label="Close" style="float:right" title="Close tip" id="close_infocard_btn"
                onclick="close_infocard(this.id)">
                <span style="color: orange" aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="card-body" >
            @Model.Info
        </div>
    </div>
}
<div id="mySidebar" class="sidebar">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    @await Html.PartialAsync("../"+controller+"/Filter")
</div>

<div id="main">
    
    <div id="openfilterbtn"><button id="openfilterbtn " class="openbtn btn" onclick="openNav()">&#9776; Open Filter</button></div>
    <div id="closefilterbtn" style="display:none"> <button class="openbtn btn" onclick="closeNav()">&#9776; Close Filter</button></div>
    <form asp-controller="Movies" asp-action="Index" method="get">
        <div class="form-floating mb-3">
            @await Html.PartialAsync("../Shared/Search")
            @await Html.PartialAsync("../Shared/MetricsFilter",  
                new MetricsFilterViewModel{Metrics= Model.Metrics, User= Model.User})
        </div>
    </form>
    <div id="DetailsDiv" style="margin-bottom:5px;"></div>
    <div id="Previews" style="width:100%">
        <div>
        @await Html.PartialAsync($"../{controller}/Recommendations", Model)
        </div>
    </div>
    <button id="loadmore_btn" type="button" class="btn btn-primary" style="margin:auto" onclick="loadmore()">Load more</button>
    
</div>

<script>
    var seen = [];
    var controller = '@controller';
    $(document).ready(function () {
        /*Loads possible values to autocomplete the text boxes*/
        SetAutoComplete("titlesearch", controller + "/GetAllNames");
        SetAutoComplete("idirector", controller + "/GetAllDirectors");
        SetAutoComplete("iactor", controller + "/GetAllActors");

        /* Sets flag seen for each item to false*/
        seen = $('.ItemPreview').map(function (ip) {
            return false;
        });

        
        /*sets popover for item previews*/
        $.fn.tooltip.Constructor.Default.allowList['*'].push('style')

        popoverExplanationOptions = {
            content: function () {
                var classname = '.popover-content' + this.id;
                return $(this).siblings(classname).html();
            },
            trigger: 'hover',
            animation: true,
            placement: 'top',
            html: true,
            title: 'Why is this item recommended?'
        };
        $('.ItemPreview').popover(popoverExplanationOptions)
        
    });

    window.onscroll = function(){
        SaveSeenInteractions();
    };
    /* if scrolled check if user seen some whole preview of item that he hasn't seen before (on this loading of page)*/

    function SaveSeenInteractions() {
        var itempreviews = $('.ItemPreview')
        for (let i = 0; i < itempreviews.length; i++) {
            if (seen[i]) continue;
            var itempreviews_top = itempreviews[i].getBoundingClientRect().top;
            var itempreviews_bottom = itempreviews[i].getBoundingClientRect().bottom;
            if (isElementInView(itempreviews[i])) {
                seen[i] = true;
                var id = itempreviews[i].id.replace('preview_', '');
                $.ajax(
                    {
                        url: "Home/SetInteraction",
                        type: "POST",
                        dataType: "json",
                        data: { id: id, type: @((int)TypeOfInteraction.Seen) },
                    }
                )
            }
        }
    }

    /* Checking if the whole element can be seen by user*/
    function isElementInView(element) {
        var pageTop = $(window).scrollTop();
        var pageBottom = pageTop + $(window).height();
        var elementTop = $(element).offset().top;
        var elementBottom = elementTop + $(element).height();        
        return ((pageTop < elementTop) && (pageBottom > elementBottom));        
    }

    var loadingmore = false;

    function loadmore() {
        if ('Movies' == '@controller')
        {
            if (!loadingmore) {
                loadingmore = true;
                $.ajax({
                    url: '@Html.Raw(loadMoreURL)',
                    cache: false,
                    success: function (data) {
                        $('#Previews').html($('#Previews')[0].innerHTML + data);
                        loadingmore = false;
                    },
                });
            }
            
        }
    }
    
</script>






